
#let CC = (
  Threat: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E957}]),
  Range: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E937}]),
  Line: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E93A}]),
  Blast: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E95B}]),
  Burst: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E938}]),
  Cone: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E939}]),
  Accuracy: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E935}]),
  Difficulty: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E943}]),
  Thrown: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E948}]),
  Melee: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E945}]),
  Grenade: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E92C}]),
  Mine: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E932}]),
  Deployable: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E92D}]),
  Drone: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E929}]),
   
  Quick: text(top-edge: "bounds", baseline:1pt, font:"Material Icons", [\u{F0AC5}]),
  Full: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F0AC8}]),
  Invade: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E917}]),
  QuickTech: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E917}]),
  FullTech: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E916}]),
  ActivationQuick: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E915}]),
  ActivationFull: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E914}]),
  FreeAction: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E91F}]),
  Reaction: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E920}]),
  Protocol: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E928}]),
  Downtime: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E919}]),
   
  Kinetic: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E940}]),
  Explosive: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E93E}]),
  Energy: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E93D}]),
  Burn: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E93C}]),
  Variable: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E941}]),
  Heat: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E93F}]),
   
  Manufacturer: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E908}]),
  License: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E901}]),
  CoreBonus: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E93B}]),
  Frame: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E944}]),
  MechSystem: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F061A}]),
  PilotGear: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E947}]),
  SkillTrigger: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E935}]),
  Bond: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F0FE8}]),
  StatusAndCondition: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E911}]),
  EquipmentTag: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F04F9}]),
  WeaponMod: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E958}]),
   
  SystemPoint: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E923}]),
  DTwenty: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F05EA}]),
  Roll: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F076E}]),
  Gear: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{e8b8}]),
  Lock: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{e898}]),
  Trait: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E959}]),
  Weapon: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E95A}]),
  WeaponProfile: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E927}]),
  NestedHexagons: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E95F}]),
   
  Slowed: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E907}]),
  Immobilized: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E906}]),
  Shredded: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E90A}]),
  Stunned: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E909}]),
  LockOn: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E90B}]),
  Jammed: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E90C}]),
  Prone: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E90E}]),
  Engaged: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E912}]),
  Hidden: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E910}]),
  Invisible: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E90F}]),
  DangerZone: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E913}]),
  Exposed: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E911}]),
  DownAndOut: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E905}]),
  ShutDown: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E90D}]),
   
  Movement: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F0058}]),
  Structure: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E955}]),
  Stress: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E949}]),
  Armor: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{e9e0}]),
  Hex: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F02D8}]),
  HollowHex: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F02D9}]),
  HP: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F02D1}]),
  Circle: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F012F}]),
  Overcharge: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F06BD}]),
  Overshield: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F06F9}]),
  Repair: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E94A}]),
  CP: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F0079}]),
  Effect: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E92B}]),
  Evasion: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E91A}]),
  EDEF: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E918}]),
  System: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E956}]),
  Activation: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E936}]),
  Deactivation: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E942}]),
  Sensors: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E926}]),
   
  ReserveTactical: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E921}]),
  ReserveMech: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E922}]),
  ReserveResource: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E960}]),
  ReserveBonus: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E935}]),
  GenericItem: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E924}]),
  Skill: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E92A}]),
  ContentManager: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E92E}]),
  Campaign: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E92F}]),
  Encounter: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E930}]),
  Compendium: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E931}]),
  Ship: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E933}]),
  Vehicle: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E934}]),
  Orbit: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E960}]),
  Orbital: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E961}]),
  LargeBeam: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E962}]),
  Ammo: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E963}]),
  Burning: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E964}]),
  Balance: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E965}]),
  Reticule: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E966}]),
  Spikes: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E967}]),
  Eclipse: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E968}]),
  SwordsArray: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E969}]),
  Marker: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E96A}]),
  Barrage: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E96B}]),
   
  SizeFour: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E953}]),
  SizeThree: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E952}]),
  SizeTwo: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E951}]),
  SizeOne: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E950}]),
  SizeHalf: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E954}]),
  Squad: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E904}]),
   
  Talent: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E92B}]),
  RankOne: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E95C}]),
  RankTwo: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E95D}]),
  RankThree: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E95E}]),
  RankCustom: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E95E}]),
   
  NPCClass: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E903}]),
  NPCFeature: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E902}]),
  NPCTemplate: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E900}]),
  Artillery: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E94B}]),
  Biological: text(top-edge: "bounds", baseline:1pt, font: "Material Icons", [\u{F05F6}]),
  Controller: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E94C}]),
  Defender: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E94F}]),
  Striker: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E94D}]),
  Support: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E94E}]),
  Balanced: text(top-edge: "bounds", baseline:1pt, font:"Material Icons", [\u{EAF6}]),
  TierOne: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E91E}]),
  TierTwo: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E91D}]),
  TierThree: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E91C}]),
  TierCustom: text(top-edge: "bounds", baseline:1pt, font: "compcon", [\u{E91B}]),
  None: "",
)

#let AutoSymbolize(s) = {
  show regex("\b(Threat|THREAT)\b"): CC.Threat
  show regex("\b(Range|RANGE)\b"): CC.Range
  show regex("\b(Line|LINE)\b"): CC.Line
  show regex("\bLine of Sight\b"): "line of sight"
  show regex("\Sensor Range\b"): "sensor range"
  show regex("\b(Blast|BLAST)\b"): CC.Blast
  show regex("\b(Burst|BURST)\b"): CC.Burst
  show regex("\b(Cone|CONE)\b"): CC.Cone
  show regex("\b(Accuracy|ACCURACY)\b"): CC.Accuracy
  show regex("\b(Difficulty|DIFFICULTY)\b"): CC.Difficulty
  show regex("\b(Kinetic|KINETIC)\b"): CC.Kinetic
  show regex("\b(Explosive|EXPLOSTIVE)\b"): CC.Explosive
  show regex("\b(Energy|ENERGY)\b"): CC.Energy
  show regex("\b(Burn|BURN)\b"): CC.Burn
  show regex("\b(Variable|VARIABLE)\b"): CC.Variable
  show regex("\b(Heat|HEAT)\b"): CC.Heat
  s
}

#let Sanitize(s) = {
  show regex("(<br>)+"): v(1em, weak: true)
  show regex("</li>"): v(1em, weak: true)

  show regex("<i>(.*?)</i>") : it => emph(it.text.slice(3,-4))
  show regex("<b>(.*?)</b>") : it => strong(it.text.slice(3,-4))
  show regex("<ul>(.*?)\z") : it => v(1em, weak: true)+list(..it.text.slice(8).split("<li>"))+v(1em, weak: true)
  show regex("<ul>(.*?)</ul>") : it => v(1em, weak: true)+list(..it.text.slice(8,-5).split("<li>"))+v(1em, weak: true)
  show regex("<ul>(.*?)<ul>") : it => v(1em, weak: true)+list(..it.text.slice(8,-4).split("<li>"))+v(1em, weak: true)
  // show regex("<ul>(.*?)\z") : it => v(1em, weak: true)+it.text.slice(8)+v(1em, weak: true)
  show regex("<span class='horus--subtle'>(.*?)</span>"): it =>text(fill:gradient.linear(purple.darken(60%), purple.darken(20%), purple.darken(60%), angle: 0deg, relative:"parent"), it.text.slice(28,-7))
  show regex("<code class='horus'>(.*?)</code>"): it =>text(fill:gradient.radial(
    (green.darken(25%), 0%),(green.darken(25%), 25%), (blue.darken(25%), 60%), (purple, 100%),
    focal-center:(50%, 10%)
    ), it.text.slice(20,-7))
  s
}

#let keywordable_text = state("keyword_the_text", true)
#let disable_keyword = state("disable_keyword", false)

#let Keyword(s) = {
    show regex("\p{Ll}+"): it => {
      text(0.7 * 1em, stroke: 0.01em + text.fill, upper(it.text))
    }
    [*#text(spacing: 80%, s)*]
}

#let NoKeyword(s) = {
  disable_keyword.update(true)
  s
  disable_keyword.update(false)
}

#let ApplyKeywords(s) = { 
    show regex("\b(Accuracy|Difficulty|Grit|HP|Size|Evasion|E-Defense|Speed|Hit Points|Hull|Agility|Systems|Engineering|Frame|Size|Armor|Core System|Mounts|Main|Auxiliary|Heavy|Superheavy|CQB|Rifle|Rifles|Launcher|Launchers|Cannon|Cannons|Nexus|Threat|CP|Core Power|SP|System Points|Full Repair|Structure|Repair Cap|Sensors|Tech Attack|Heat Cap|Stress|Save Target|Boost|Boosts|Range|Overwatch|Grappling|Improvised Attacks|Knockback|Grapple|Ram|Stunned|Immobilized|Prone|Impaired|Slowed|Lock On|Drone|Drones|Shredded|Engaged|Melee|Resistance|Line|Burst|Blast|Cone|Limited|Jammed|Mount|Dismount|Shut Down|Heat|Hidden|Quick Tech|Full Tech|AI|Skirmish|Barrage|Arcing|Armor-Piercing|Inaccurate|Loading|Ordnance|Protocols|Protocol|Overkill|Overshield|Reliable|Seeking|Smart|Thrown|Active|Danger Zone|Deployable|Grenade|Invade|Invasion|Fragment Signal|Mine|Mod|Reaction|Shield|Burn|Kinetic|Explosive|Energy|Exposed|Repair|Intangible|Immunity|Charges|Charge|Stabilize|Bolster|AP|Invisible)\b"): it => context if(keywordable_text.get() and not disable_keyword.get()) { Keyword(it) } else { it } 
    show regex("\bE-Defence\b"): "E-Defense" //(This spelling is used in Liminal Space at least.)
    s
}